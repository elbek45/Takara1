# Takara Gold v2.2 - Implementation Plan

## Overview
Major update introducing TAKARA boost, tax system, instant sales, and revised APY structure.

---

## ‚úÖ COMPLETED

### 1. Database Schema (DONE)
- ‚úÖ Created migration `20251205123000_v2_2_takara_boost_and_taxes`
- ‚úÖ Renamed `Vault.miningPower` ‚Üí `Vault.takaraAPY`
- ‚úÖ Renamed `TakaraMining.miningPower` ‚Üí `TakaraMining.takaraAPY`
- ‚úÖ Added `Investment.takaraBoost` relation
- ‚úÖ Added `Investment.instantSalePrice` and `isInstantSaleEnabled`
- ‚úÖ Created `TakaraBoost` model
- ‚úÖ Created `BoostTokenConfig` model
- ‚úÖ Created `TaxRecord` model
- ‚úÖ Created `TreasuryBalance` model

### 2. Scripts (DONE)
- ‚úÖ Created `update-vaults-v2-2.js` - Updates vault APY values
- ‚úÖ Created `create-wexel-collection.js` - WEXEL collection creation (previous work)

### 3. Services (DONE)
- ‚úÖ Created `tax.service.ts` - Tax calculation and treasury management

---

## üöß IN PROGRESS / TODO

### 4. Backend Controllers & Services

#### 4.1 Update Withdrawal Controller (PRIORITY)
**File**: `backend/src/controllers/withdrawal.controller.ts`

**Changes needed**:
```typescript
// In processTakaraWithdrawal function
import { applyTakaraClaimTax } from '../services/tax.service';

// Before transfer, apply 5% tax
const taxResult = await applyTakaraClaimTax({
  userId: withdrawal.userId,
  transactionId: withdrawal.id,
  takaraAmount: Number(withdrawal.takaraAmount),
  platformWallet
});

// Transfer amountAfterTax instead of full amount
// Update withdrawal record with tax info
```

#### 4.2 Update Marketplace Controller
**File**: `backend/src/controllers/marketplace.controller.ts`

**Changes needed**:
```typescript
// In buyListing/acceptOffer functions
import { applyWexelSaleTax } from '../services/tax.service';

// Apply 5% tax on sale price
const taxResult = await applyWexelSaleTax({
  userId: seller.id,
  investmentId: listing.investmentId,
  salePrice: listing.price,
  platformWallet
});

// Transfer (price - taxAmount) to seller
```

#### 4.3 Create Instant Sale Service
**File**: `backend/src/services/instantSale.service.ts`

**Features**:
- Calculate instant sale price (20% below market value)
- Execute instant sale
- Transfer funds to user
- Apply 5% tax
- Update NFT ownership

#### 4.4 Create TAKARA Boost Service
**File**: `backend/src/services/takaraBoost.service.ts`

**Features**:
- Similar to `laikaBoost.service.ts`
- Apply TAKARA boost to investment
- Calculate additional APY
- Lock TAKARA tokens
- Return TAKARA on investment completion

#### 4.5 Update Investment Service
**File**: `backend/src/services/investment.service.ts`

**Changes**:
- Support TAKARA boost in addition to LAIKA boost
- Update APY calculation with both boosts
- Update mining calculation with new takaraAPY field

#### 4.6 Create Admin Boost Controller
**File**: `backend/src/controllers/admin-boost.controller.ts`

**Features**:
- Get all boost token configs
- Update boost token (enable/disable, max boost %)
- Add new boost token
- Remove boost token

#### 4.7 Create Admin Treasury Controller
**File**: `backend/src/controllers/admin-treasury.controller.ts`

**Features**:
- Get treasury balances
- Get tax statistics
- Withdraw from treasury (super admin only)
- View tax records

---

### 5. Backend Routes

#### 5.1 Admin Routes
**File**: `backend/src/routes/admin.routes.ts`

```typescript
// Boost Token Management
router.get('/boost-tokens', requireSuperAdmin, adminBoostController.getBoostTokens);
router.put('/boost-tokens/:symbol', requireSuperAdmin, adminBoostController.updateBoostToken);
router.post('/boost-tokens', requireSuperAdmin, adminBoostController.createBoostToken);

// Treasury Management
router.get('/treasury/balances', requireSuperAdmin, adminTreasuryController.getBalances);
router.get('/treasury/statistics', requireSuperAdmin, adminTreasuryController.getStatistics);
router.post('/treasury/withdraw', requireSuperAdmin, adminTreasuryController.withdraw);
router.get('/treasury/tax-records', requireSuperAdmin, adminTreasuryController.getTaxRecords);
```

#### 5.2 Investment Routes
**File**: `backend/src/routes/investment.routes.ts`

```typescript
// Add TAKARA boost
router.post('/:id/boost/takara', authenticateUser, investmentController.applyTakaraBoost);

// Enable/disable instant sale
router.put('/:id/instant-sale', authenticateUser, investmentController.toggleInstantSale);

// Execute instant sale
router.post('/:id/instant-sale/execute', authenticateUser, investmentController.executeInstantSale);
```

---

### 6. Frontend Updates

#### 6.1 Terminology Updates (GLOBAL)
**Search and replace across all frontend files**:
- "Mining Power" ‚Üí "Takara APY"
- "miningPower" ‚Üí "takaraAPY"
- Add "up to" before Takara APY values
- "Max APY" ‚Üí "Max APY with boost"
- "LKI" ‚Üí "LAIKA"
- "LAIKA" ‚Üí "LAIKA The Cosmodog" (where appropriate)

#### 6.2 Homepage Banner
**File**: `frontend/src/pages/HomePage.tsx`

Add banner:
```tsx
<div className="bg-gradient-to-r from-blue-600 to-purple-600 p-4 text-center">
  <p className="text-white font-semibold">
    üöÄ Token listing will begin once all 21,000,000 TAKARA tokens are mined!
  </p>
</div>
```

#### 6.3 Vault Card Updates
**Files**:
- `frontend/src/components/VaultCard.tsx`
- `frontend/src/pages/VaultsPage.tsx`

**Changes**:
- Update labels: "Mining Power" ‚Üí "Takara APY"
- Show "up to X%" format
- Show "Max APY with boost" label
- Update boost section to show both LAIKA and TAKARA options

#### 6.4 Investment Details
**File**: `frontend/src/pages/InvestmentDetailsPage.tsx`

**Add**:
- TAKARA boost section (if applicable)
- Instant sale toggle and execute button
- Tax information display
- Updated APY display

#### 6.5 Withdrawal Page
**File**: `frontend/src/pages/WithdrawalPage.tsx`

**Add**:
- Tax preview (5% on TAKARA)
- "Amount after tax" display
- Tax explanation tooltip

#### 6.6 Admin Pages

**New Page**: `frontend/src/pages/admin/AdminBoostTokensPage.tsx`
- List all boost tokens
- Enable/disable toggles
- Edit max boost percentage
- Add new boost token button

**New Page**: `frontend/src/pages/admin/AdminTreasuryPage.tsx`
- Treasury balance display
- Tax statistics (charts)
- Tax records table
- Withdraw button (super admin)

**Update**: `frontend/src/components/admin/AdminLayout.tsx`
- Add "Boost Tokens" menu item
- Add "Treasury" menu item

---

### 7. API Services

#### 7.1 Admin API
**File**: `frontend/src/services/admin.api.ts`

```typescript
// Boost Tokens
getBoostTokens: async () => { ... }
updateBoostToken: async (symbol: string, data: any) => { ... }
createBoostToken: async (data: any) => { ... }

// Treasury
getTreasuryBalances: async () => { ... }
getTreasuryStatistics: async (params?: any) => { ... }
withdrawFromTreasury: async (data: any) => { ... }
getTaxRecords: async (params?: any) => { ... }
```

#### 7.2 Investment API
**File**: `frontend/src/services/investment.api.ts`

```typescript
applyTakaraBoost: async (investmentId: string, data: any) => { ... }
toggleInstantSale: async (investmentId: string, enabled: boolean) => { ... }
executeInstantSale: async (investmentId: string) => { ... }
```

---

### 8. Database Seeding

#### 8.1 Run Migration
```bash
cd backend
npx prisma migrate deploy
npx prisma generate
```

#### 8.2 Update Vaults
```bash
node scripts/update-vaults-v2-2.js
```

#### 8.3 Seed Boost Tokens
Already done in migration, but verify:
- LAIKA: enabled, 100% max boost
- TAKARA: enabled, 100% max boost

#### 8.4 Initialize Treasury
Already done in migration:
- TAKARA: 0 balance
- USDT: 0 balance

---

### 9. Environment Variables

#### Add to `.env.mainnet`:
```bash
# Treasury
TREASURY_WALLET_ADDRESS=<treasury_wallet_address>
TREASURY_WALLET_PRIVATE_KEY=<treasury_private_key>

# Tax Rate (already hardcoded to 5%)
TAX_RATE_PERCENT=5
```

---

### 10. Testing Checklist

#### Backend Tests:
- [ ] Tax calculation (5% accurate)
- [ ] TAKARA claim with tax
- [ ] WEXEL sale with tax
- [ ] Treasury balance updates
- [ ] TAKARA boost application
- [ ] Instant sale (20% discount)
- [ ] Boost token admin CRUD

#### Frontend Tests:
- [ ] All "Mining Power" changed to "Takara APY"
- [ ] "up to X%" displays correctly
- [ ] Listing banner shows on homepage
- [ ] LAIKA rebranded everywhere
- [ ] Tax preview on withdrawal
- [ ] Instant sale UI works
- [ ] Admin boost tokens page
- [ ] Admin treasury page

#### Integration Tests:
- [ ] Full investment flow with TAKARA boost
- [ ] Withdrawal with 5% tax deduction
- [ ] NFT sale with 5% tax deduction
- [ ] Instant sale complete flow
- [ ] Admin can enable/disable boost tokens
- [ ] Treasury accumulates correctly

---

### 11. Deployment Steps

1. **Backup Database**
```bash
pg_dump takara_gold > backup_before_v2_2.sql
```

2. **Run Migration**
```bash
cd backend
npx prisma migrate deploy
```

3. **Update Vaults**
```bash
node scripts/update-vaults-v2-2.js
```

4. **Deploy Backend**
```bash
npm run build
pm2 restart takara-backend
```

5. **Deploy Frontend**
```bash
cd frontend
npm run build
# Deploy dist/ to nginx
```

6. **Verify**
- Check vault APY values
- Check boost tokens configured
- Check treasury initialized
- Test tax on testnet first!

---

### 12. Documentation

#### Update README:
- v2.2 features
- Tax system explanation
- TAKARA boost explanation
- Instant sale feature

#### Update API Docs:
- New endpoints
- Tax fields in responses
- Boost token endpoints

---

## üìä New APY Values Summary

| Vault | Duration | Base APY | Max APY (with boost) | Takara APY |
|-------|----------|----------|----------------------|------------|
| Pro   | 12M      | 12%      | 24%                  | up to 50%  |
| Pro   | 30M      | 20.5%    | 41%                  | up to 100% |
| Pro   | 36M      | 25%      | 50%                  | up to 150% |
| Elite | 12M      | 15%      | 30%                  | up to 150% |
| Elite | 30M      | 17%      | 34%                  | up to 250% |
| Elite | 36M      | 19%      | 38%                  | up to 350% |

**All payouts**: MONTHLY

---

## üí∞ Tax System Summary

- **TAKARA Claims**: 5% tax ‚Üí Treasury (in TAKARA)
- **WEXEL Sales**: 5% tax ‚Üí Treasury (in USDT)
- Treasury tracks all collected taxes
- Admin can view statistics and withdraw

---

## üöÄ TAKARA Supply

- **Total Supply**: 600,000,000 TAKARA
- **For Mining**: 21,000,000 TAKARA
- **Initial Mint**: 60,000,000 TAKARA (10%)
- **Listing**: After all mining tokens are distributed

---

## üìù Notes

- TAKARA boost works same as LAIKA boost
- Users can apply BOTH LAIKA and TAKARA boost
- Instant sale gives 20% discount for quick liquidity
- Tax is automatic, no user action needed
- Treasury is controlled by super admin only

---

## üîó Related Files

### Backend:
- `prisma/schema.prisma`
- `scripts/update-vaults-v2-2.js`
- `src/services/tax.service.ts`
- (To be created: takaraBoost, instantSale services)
- (To be updated: withdrawal, marketplace controllers)

### Frontend:
- (To be updated: All vault/investment pages)
- (To be created: Admin boost tokens, treasury pages)

---

**Status**: 30% Complete
**Next Priority**: Backend controller updates for tax integration
