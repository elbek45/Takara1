// Takara Gold v2.1.1 Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER MODELS ====================

model User {
  id                String              @id @default(uuid())
  walletAddress     String?             @unique // Solana wallet address (Phantom)
  ethereumAddress   String?             @unique // Ethereum wallet address (MetaMask)
  tronAddress       String?             @unique // TRON wallet address (Trust Wallet)
  email             String?             @unique
  username          String?             @unique
  password          String? // Hashed password for username/password auth
  avatarUrl         String?
  role              UserRole            @default(USER)
  isActive          Boolean             @default(true)

  // Stats
  totalInvested     Decimal             @default(0) @db.Decimal(20, 6)
  totalEarnedUSDT   Decimal             @default(0) @db.Decimal(20, 6)
  totalMinedTAKARA  Decimal             @default(0) @db.Decimal(20, 6)

  // Relationships
  investments       Investment[]
  withdrawals       WithdrawalRequest[]
  listings          MarketplaceListing[]
  referrals         Referral[]          @relation("Referrer")
  referredBy        Referral?           @relation("Referred")
  taxRecords        TaxRecord[]         // Tax history (v2.2)
  claimRequests     ClaimRequest[]      // Claim requests (v2.2)

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  lastLoginAt       DateTime?

  @@index([walletAddress])
  @@index([ethereumAddress])
  @@index([tronAddress])
  @@index([email])
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// ==================== VAULT MODELS ====================

model Vault {
  id              String        @id @default(uuid())
  name            String        @unique // e.g., "Pro Vault 12M"
  tier            VaultTier     // STARTER, PRO, ELITE
  duration        Int           // months: 12, 30, 36
  payoutSchedule  PayoutSchedule @default(MONTHLY) // All payouts are now MONTHLY

  // Requirements
  minInvestment   Decimal       @db.Decimal(20, 2) // Min USDT
  maxInvestment   Decimal       @db.Decimal(20, 2) // Max USDT
  requireTAKARA   Boolean       @default(false)
  takaraRatio     Decimal?      @db.Decimal(10, 2) // e.g., 30 or 50 per 100 USDT

  // Rewards (Updated v2.2)
  baseAPY         Decimal       @db.Decimal(10, 2) // Base APY (e.g., 12.0, 20.5, 25.0, or 100000 for test)
  maxAPY          Decimal       @db.Decimal(10, 2) // Max APY with boost (LAIKA/TAKARA)
  baseTakaraAPY   Decimal       @db.Decimal(10, 2) // Base TAKARA mining APY
  maxTakaraAPY    Decimal       @db.Decimal(10, 2) // Max TAKARA mining APY with boost

  // Status
  isActive        Boolean       @default(true)
  totalCapacity   Decimal?      @db.Decimal(20, 2) // Max total USDT
  currentFilled   Decimal       @default(0) @db.Decimal(20, 2)

  // Mining Threshold (v2.3)
  miningThreshold Decimal       @default(100000) @db.Decimal(20, 2) // Mining starts when currentFilled >= this
  isMining        Boolean       @default(false) // True when threshold reached

  // Accepted Payment Methods (v2.3) - comma-separated: USDT,TAKARA,TRX
  acceptedPayments String       @default("USDT") // Which tokens can be used to invest

  // Relationships
  investments     Investment[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([tier])
  @@index([isActive])
  @@map("vaults")
}

enum VaultTier {
  STARTER // Tier 1
  PRO     // Tier 2
  ELITE   // Tier 3
}

enum PayoutSchedule {
  HOURLY        // Every hour (for testing)
  DAILY         // Every day (for testing)
  MONTHLY       // Every 30 days
  QUARTERLY     // Every 90 days
  END_OF_TERM   // Only at the end
}

// ==================== INVESTMENT MODELS ====================

model Investment {
  id                  String              @id @default(uuid())

  // User & Vault
  userId              String
  user                User                @relation(fields: [userId], references: [id])
  vaultId             String
  vault               Vault               @relation(fields: [vaultId], references: [id])

  // Investment Details
  usdtAmount          Decimal             @db.Decimal(20, 6) // USDT invested
  takaraRequired      Decimal             @default(0) @db.Decimal(20, 6) // TAKARA required
  takaraLocked        Decimal             @default(0) @db.Decimal(20, 6) // TAKARA actually locked

  // Boost System (v2.2)
  laikaBoost          LaikaBoost?
  takaraBoost         TakaraBoost?        // NEW: TAKARA boost support
  finalAPY            Decimal             @db.Decimal(10, 2) // After boost (supports up to 99999999.99%)

  // NFT
  nftMintAddress      String?             @unique // Solana NFT mint address
  nftMetadataUri      String?

  // Instant Sale (v2.2)
  instantSalePrice    Decimal?            @db.Decimal(20, 6) // 20% below market value
  isInstantSaleEnabled Boolean            @default(false)

  // Timeline
  startDate           DateTime            @default(now())
  endDate             DateTime            // Calculated: startDate + vault.duration
  lastClaimDate       DateTime?
  nextPayoutDate      DateTime?

  // Earnings
  totalEarnedUSDT     Decimal             @default(0) @db.Decimal(20, 6)
  totalMinedTAKARA    Decimal             @default(0) @db.Decimal(20, 6)
  pendingUSDT         Decimal             @default(0) @db.Decimal(20, 6)
  pendingTAKARA       Decimal             @default(0) @db.Decimal(20, 6)

  // Status
  status              InvestmentStatus    @default(PENDING)
  isNFTMinted         Boolean             @default(false)

  // Relationships
  takaraMining        TakaraMining[]
  marketplaceListing  MarketplaceListing?
  transactions        Transaction[]
  claimRequests       ClaimRequest[]      // Claim requests (v2.2)

  // Solana Transaction
  depositTxSignature  String?             // Initial deposit transaction

  // 2-Step Process (MetaMask USDT â†’ Phantom LAIKA/TAKARA)
  usdtTxHash          String?             // Ethereum/TRON USDT transaction hash (Step 1)
  laikaTxHash         String?             // Solana LAIKA transaction hash (Step 2, optional)
  takaraTxHash        String?             // Solana TAKARA transaction hash (Step 2, if required)
  step1CompletedAt    DateTime?           // When USDT payment confirmed
  step2CompletedAt    DateTime?           // When tokens deposited and NFT minted
  paymentChain        String?             // 'ethereum' or 'tron'
  tokenChain          String?             @default("solana") // Always 'solana' for now

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([userId, status])
  @@index([vaultId, status])
  @@index([status])
  @@index([nftMintAddress])
  @@index([usdtTxHash])
  @@map("investments")
}

enum InvestmentStatus {
  PENDING_USDT    // Step 1: Waiting for USDT payment (MetaMask)
  PENDING_TOKENS  // Step 2: USDT paid, waiting for LAIKA/TAKARA (Phantom)
  PENDING         // Waiting for activation (72h timer)
  ACTIVE          // Currently earning
  COMPLETED       // Ended successfully
  WITHDRAWN       // Early withdrawal
  SOLD            // Sold on marketplace
  CANCELLED       // Cancelled by admin
}

// ==================== LAIKA BOOST ====================

model LaikaBoost {
  id                String        @id @default(uuid())

  investmentId      String        @unique
  investment        Investment    @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  // LAIKA Details
  laikaAmount       Decimal       @db.Decimal(20, 6) // LAIKA tokens deposited
  laikaValueUSD     Decimal       @db.Decimal(20, 2) // USD value at deposit
  maxAllowedUSD     Decimal       @db.Decimal(20, 2) // 90% of USDT investment

  // Boost Calculation
  boostPercentage   Decimal       @db.Decimal(5, 2) // % of max boost applied
  additionalAPY     Decimal       @db.Decimal(5, 2) // APY added by boost

  // Return
  isReturned        Boolean       @default(false)
  returnDate        DateTime?
  returnTxSignature String?

  depositTxSignature String?      // LAIKA deposit transaction

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([investmentId])
  @@map("laika_boosts")
}

// ==================== TAKARA BOOST (v2.2) ====================

model TakaraBoost {
  id                String        @id @default(uuid())

  investmentId      String        @unique
  investment        Investment    @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  // TAKARA Details
  takaraAmount      Decimal       @db.Decimal(20, 6) // TAKARA tokens deposited
  takaraValueUSD    Decimal       @db.Decimal(20, 2) // USD value at deposit
  maxAllowedUSD     Decimal       @db.Decimal(20, 2) // 90% of USDT investment

  // Boost Calculation
  boostPercentage   Decimal       @db.Decimal(5, 2) // % of max boost applied
  additionalAPY     Decimal       @db.Decimal(5, 2) // APY added by boost

  // Return
  isReturned        Boolean       @default(false)
  returnDate        DateTime?
  returnTxSignature String?

  depositTxSignature String?      // TAKARA deposit transaction

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([investmentId])
  @@map("takara_boosts")
}

// ==================== TAKARA MINING ====================

model TakaraMining {
  id                String        @id @default(uuid())

  investmentId      String
  investment        Investment    @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  // Mining Details
  miningDate        DateTime      @default(now())
  takaraAPY         Decimal       @db.Decimal(10, 2) // Takara APY from vault config (v2.2) - increased for test vaults
  difficulty        Decimal       @db.Decimal(10, 6) // Network difficulty that day

  // Rewards
  takaraMinedRaw    Decimal       @db.Decimal(20, 6) // Before difficulty
  takaraMinedFinal  Decimal       @db.Decimal(20, 6) // After difficulty

  // Metadata
  totalMinedSoFar   Decimal       @db.Decimal(20, 6) // Network total at this point
  activeMiners      Int           // Active miners that day

  createdAt         DateTime      @default(now())

  @@index([investmentId, miningDate])
  @@index([miningDate])
  @@map("takara_mining")
}

// Global mining stats
model MiningStats {
  id                String        @id @default(uuid())

  date              DateTime      @unique @default(now())

  // TAKARA Supply Tracking (v2.3 - User requirement)
  totalMined        Decimal       @db.Decimal(20, 6) // Total TAKARA mined to date
  totalEntryLocked  Decimal       @default(0) @db.Decimal(20, 6) // Entry requirement TAKARA (will be returned)
  totalBoostLocked  Decimal       @default(0) @db.Decimal(20, 6) // Boost TAKARA (will be returned)
  totalClaimTax     Decimal       @default(0) @db.Decimal(20, 6) // 5% claim tax (stays in treasury)

  // Circulating Supply = totalMined + totalEntryLocked + totalBoostLocked (excludes claim tax)
  // This represents all TAKARA that belongs to users (mined + will be returned)
  circulatingSupply Decimal       @default(0) @db.Decimal(20, 6)

  activeMiners      Int           // Active investments mining
  currentDifficulty Decimal       @db.Decimal(10, 6)

  createdAt         DateTime      @default(now())

  @@index([date])
  @@map("mining_stats")
}

// ==================== MARKETPLACE ====================

model MarketplaceListing {
  id                String              @id @default(uuid())

  // Investment NFT
  investmentId      String              @unique
  investment        Investment          @relation(fields: [investmentId], references: [id])

  // Seller
  sellerId          String
  seller            User                @relation(fields: [sellerId], references: [id])

  // Listing Details
  priceUSDT         Decimal             @db.Decimal(20, 6)
  originalInvestment Decimal            @db.Decimal(20, 6) // Original USDT amount
  currentValue      Decimal             @db.Decimal(20, 6) // With earnings

  // Status
  status            ListingStatus       @default(ACTIVE)

  // Sale
  buyerId           String?
  soldPrice         Decimal?            @db.Decimal(20, 6)
  soldAt            DateTime?
  saleTxSignature   String?

  // Fees
  platformFee       Decimal             @default(2.5) @db.Decimal(5, 2) // %

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([status])
  @@index([sellerId])
  @@map("marketplace_listings")
}

enum ListingStatus {
  ACTIVE
  SOLD
  CANCELLED
  EXPIRED
}

// ==================== WITHDRAWALS ====================

model WithdrawalRequest {
  id                String            @id @default(uuid())

  userId            String
  user              User              @relation(fields: [userId], references: [id])

  // Withdrawal Details
  amount            Decimal           @db.Decimal(20, 6)
  tokenType         TokenType         // USDT, TAKARA, LAIKA
  destinationWallet String            // Solana address

  // Status
  status            WithdrawalStatus  @default(PENDING)

  // Processing
  processedAt       DateTime?
  processedBy       String?           // Admin ID
  txSignature       String?           // Solana transaction

  // Rejection
  rejectionReason   String?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId, status])
  @@index([status])
  @@map("withdrawal_requests")
}

enum TokenType {
  USDT
  TAKARA
  LAIKA
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
}

// ==================== TRANSACTIONS ====================

model Transaction {
  id                String            @id @default(uuid())

  investmentId      String?
  investment        Investment?       @relation(fields: [investmentId], references: [id])

  // Transaction Details
  type              TransactionType
  amount            Decimal           @db.Decimal(20, 6)
  tokenType         TokenType

  // Solana
  txSignature       String            @unique
  fromAddress       String
  toAddress         String

  // Status
  status            TxStatus          @default(PENDING)
  confirmations     Int               @default(0)

  // Metadata
  description       String?
  metadata          Json?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([txSignature])
  @@index([status])
  @@map("transactions")
}

enum TransactionType {
  DEPOSIT           // User deposits USDT/TAKARA
  LAIKA_DEPOSIT     // User deposits LAIKA for boost
  LAIKA_RETURN      // LAIKA returned to user
  YIELD_CLAIM       // User claims USDT yield
  TAKARA_CLAIM      // User claims mined TAKARA
  WITHDRAWAL        // User withdraws tokens
  NFT_SALE          // Marketplace sale
  NFT_TRANSFER      // NFT ownership transfer
}

enum TxStatus {
  PENDING
  CONFIRMED
  FAILED
}

// ==================== REFERRAL SYSTEM ====================

model Referral {
  id                String        @id @default(uuid())

  // Referrer (who shared the link)
  referrerId        String
  referrer          User          @relation("Referrer", fields: [referrerId], references: [id])

  // Referred (who joined)
  referredId        String        @unique
  referred          User          @relation("Referred", fields: [referredId], references: [id])

  // Rewards
  totalEarned       Decimal       @default(0) @db.Decimal(20, 6)

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([referrerId])
  @@map("referrals")
}

// ==================== ADMIN ====================

model AdminUser {
  id                String        @id @default(uuid())

  username          String        @unique
  email             String        @unique
  passwordHash      String

  role              AdminRole     @default(ADMIN)
  isActive          Boolean       @default(true)

  lastLoginAt       DateTime?
  lastLoginIP       String?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@map("admin_users")
}

enum AdminRole {
  ADMIN
  SUPER_ADMIN
}

// ==================== SYSTEM CONFIG ====================

model SystemConfig {
  id                String        @id @default(uuid())

  key               String        @unique
  value             String
  description       String?

  updatedAt         DateTime      @updatedAt

  @@map("system_config")
}

// ==================== BOOST TOKEN CONFIG (v2.2) ====================

model BoostTokenConfig {
  id                String        @id @default(uuid())

  tokenSymbol       String        @unique // 'LAIKA' or 'TAKARA'
  tokenName         String        // 'LAIKA The Cosmodog' or 'Takara Gold'
  tokenMint         String        // Solana mint address

  isEnabled         Boolean       @default(true) // Admin can enable/disable
  maxBoostPercent   Decimal       @db.Decimal(5, 2) // Max boost this token provides

  // Display order in UI
  displayOrder      Int           @default(0)

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([isEnabled])
  @@map("boost_token_config")
}

// ==================== TAX RECORDS (v2.2) ====================

model TaxRecord {
  id                String        @id @default(uuid())

  // Source
  sourceType        TaxSourceType // TAKARA_CLAIM or WEXEL_SALE
  sourceId          String        // Transaction ID or Investment ID
  userId            String
  user              User          @relation(fields: [userId], references: [id])

  // Tax Details
  tokenSymbol       String        // 'TAKARA' or 'USDT'
  amountBeforeTax   Decimal       @db.Decimal(20, 6)
  taxPercent        Decimal       @db.Decimal(5, 2) // 5.00
  taxAmount         Decimal       @db.Decimal(20, 6) // Amount sent to treasury
  amountAfterTax    Decimal       @db.Decimal(20, 6)

  // Transaction
  txSignature       String?       // Solana transaction signature
  treasuryWallet    String        // Where tax was sent

  createdAt         DateTime      @default(now())

  @@index([userId])
  @@index([sourceType])
  @@index([createdAt])
  @@map("tax_records")
}

enum TaxSourceType {
  TAKARA_CLAIM    // 5% tax on TAKARA claim
  WEXEL_SALE      // 5% tax on WEXEL NFT sale
}

// ==================== TREASURY BALANCE (v2.2) ====================

model TreasuryBalance {
  id                String        @id @default(uuid())

  tokenSymbol       String        @unique // 'TAKARA' or 'USDT'
  balance           Decimal       @default(0) @db.Decimal(20, 6)

  // Stats
  totalCollected    Decimal       @default(0) @db.Decimal(20, 6) // All-time collected
  totalWithdrawn    Decimal       @default(0) @db.Decimal(20, 6) // All-time withdrawn by admin

  updatedAt         DateTime      @updatedAt

  @@map("treasury_balance")
}

// ==================== CLAIM REQUESTS (v2.2) ====================

model ClaimRequest {
  id                String            @id @default(uuid())

  // User & Investment
  userId            String
  user              User              @relation(fields: [userId], references: [id])
  investmentId      String
  investment        Investment        @relation(fields: [investmentId], references: [id])

  // Claim Details
  claimType         ClaimType         // USDT or TAKARA
  amount            Decimal           @db.Decimal(20, 6)

  // Tax (for TAKARA claims)
  taxAmount         Decimal           @default(0) @db.Decimal(20, 6)
  amountAfterTax    Decimal           @db.Decimal(20, 6)

  // Status
  status            ClaimRequestStatus @default(PENDING)

  // Processing
  processedBy       String?           // Admin ID who processed
  processedAt       DateTime?
  txSignature       String?           // Transaction signature after processing
  rejectionReason   String?

  // Wallet info
  destinationWallet String            // Where to send funds

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
  @@index([investmentId])
  @@index([status])
  @@index([createdAt])
  @@map("claim_requests")
}

enum ClaimType {
  USDT
  TAKARA
}

enum ClaimRequestStatus {
  PENDING     // Waiting for admin approval
  APPROVED    // Approved, waiting for transfer
  PROCESSING  // Transfer in progress
  COMPLETED   // Successfully transferred
  REJECTED    // Rejected by admin
  FAILED      // Transfer failed
}

// ==================== PARTNERS (Powered By Slider) ====================

model Partner {
  id                String        @id @default(uuid())

  name              String        // Partner/technology name
  logoUrl           String        // Path to logo image
  websiteUrl        String?       // Optional website link

  // Display
  displayOrder      Int           @default(0) // Order in slider
  isActive          Boolean       @default(true)

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([isActive, displayOrder])
  @@map("partners")
}
