/**
 * Deploy Mock USDT Contract to Sepolia Testnet
 *
 * Prerequisites:
 * 1. Get Sepolia ETH from faucet: https://sepoliafaucet.com/
 * 2. Set PLATFORM_ETHEREUM_PRIVATE_KEY in environment
 *
 * Usage:
 * PLATFORM_ETHEREUM_PRIVATE_KEY=0x... node scripts/deploy-mock-usdt.js
 */

const { Web3 } = require('web3');
const fs = require('fs');
const path = require('path');

// Configuration
const SEPOLIA_RPC_URL = 'https://rpc.sepolia.org'; // Free public RPC
const PRIVATE_KEY = process.env.PLATFORM_ETHEREUM_PRIVATE_KEY || '0xdf074bfbd94bca6ab0844c56ce5d42bb023d056cf931a933a371551a7bc9bd60';

// Read contract source
const contractPath = path.join(__dirname, '../contracts/MockUSDT.sol');
const contractSource = fs.readFileSync(contractPath, 'utf8');

// Contract bytecode and ABI (pre-compiled)
// This is the compiled bytecode for the MockUSDT contract
const CONTRACT_BYTECODE = '0x608060405234801561001057600080fd5b506100326ec097ce7bc90715b34b9f1000000000336100ea60201b60201c565b61021f565b600060405180604001604052806010815260200160007f4d6f636b20546574686572205553440000000000000000000000000000000000815250600090816100839190610413565b506040518060400160405280600481526020017f555344540000000000000000000000000000000000000000000000000000000081525060019081 6100c89190610413565b506006600260006101000a81548160ff021916908360ff1602179055506104e5565b80600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546101399190610525565b925050 8190555080600260016101000a8154816101519190610525565b02508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516101b191906105 b0565b60405180910390a38173ffffffffffffffffffffffffffffffffffffffff167f0f6798a560793a54c3bcfe86a93cde1e73087d944c0ea20544137d4121396885826040516101ff91906105b0565b60405180910390a25050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061029757607f821691505b6020821 0036102ab576102aa61025a565b5b50919050565b60008190508160005260206000209050919050565b600081546102d381610289565b6102dd81866102ab565b945060018216600081146102f857600181146103095761033c565b60ff198316865281151582028601935061033c565b610312856102b1565b60005b8381101561033457815481890152600182019150602081019050610315565b838801955050505b50505092915050565b600082825260208201905092915050565b600061036182610345565b61036b8185610345565b935061037b8185 60208601610350565b61038481610221565b840191505092915050565b60006040820190506103a46000830184610356565b6103b1602083018461039b565b92915050565b60006103c282610345565b6103cc8185610345565b93506103dc818560208601610350565b6103e581610221565b840191505092915050565b60006103fb826103b7565b9150610406836103b7565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffff ffffffffff0382111561043b5761043a610506565b5b828201905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060208201905081810360008301526104af816103b7565b9050919050565b6108e5806104c56000396000f3fe608060405234801561001057600080fd5b5060043610610 0a95760003560e01c806370a082311161006657806370a08231146101a857806395d89b41146101d8578063a0712d68146101f6578063a9059cbb14610212578063dd62ed3e14610242578063f46eccc41461027257610095565b8063095ea7b3146100a957806318160ddd146100d957806323b872dd146100f7578063313ce5671461012757806340c10f191461014557806355d3cf711461016157610095565b5b600080fd5b6100c360048036038101906100be9190610629565b61028e565b6040516100d09190610682565b60405180910390f35b6100e1610346565b6040516100ee91906106ac565b60405180910390f35b610111600480360381019061010c91906106c7565b61034c565b60405161011e9190610682565b60405180910390f35b61012f6105a5565b60405161013c9190610736565b60405180910390f35b61015f600480360381019061015a9190610629565b6105b8565b005b6101696105c4565b604051610 17691906107ba565b60405180910390f35b6101c260048036038101906101bd91906107d5565b6105ea565b6040516101cf91906106ac565b60405180910390f35b6101e0610602565b6040516101ed919061088c565b60405180910390f35b610210600480360381019061020b91906108ae565b610690565b005b61022c60048036038101906102279190610629565b6106e8565b6040516102399190610682565b60405180910390f35b61025c600480360381019061025791906108db565b6107b0565b60405161026991906106ac565b60405180910390f35b61028c600480360381019061028791906107d5565b6107d5565b005b600081600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258460405161036e91906106ac565b60405180910390a36001905092915050565b60025481565b600081600360008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205410156103d0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103c790610985565b60405180910390fd5b81600460008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054101561048f576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610486906109f1565b60405180910390fd5b81600360008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546104de9190610a40565b9250508190555081600360008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461053491906109bb565b9250508190555081600460008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546105c69190610a40565b925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8460405161062a91906106ac565b60405180910390a3600190509392505050565b60008135905061064c81610870565b92915050565b60008135905061066181610887565b92915050565b6000813590506106768161089e565b92915050565b61068581610834565b82525050565b6106948161085e565b82525050565b60006106a7601483610a7c565b91507f496e73756666696369656e742062616c616e63650000000000000000000000006000830152602082019050919050565b60006106e7601183610a7c565b91507f416c6c6f77616e6365206578636565646564 0000000000000000000000000000006000830152602082019050919050565b60006020820190506107226000830184610682565b92915050565b600060208201905061073d600083018461068b565b92915050565b6000604082019050610758600083018561067c565b610765602083018461067c565b9392505050565b600060608201905061078160008301866107b7565b61078e60208301856107b7565b61079b604083018461067c565b949350505050565b6107ac81610848565b82525050565b6107bb81610848565b82525050565b60006020820190506107d660008301846107b7565b92915050565b6000602082840312156107f2576107f1610868565b5b600061080084828501610652565b91505092915050565b60008060408385031215610820576108 1f610868565b5b600061082e85828601610652565b925050602061083f85828601610667565b9150509250929050565b600061085482610828565b9050919050565b60008115159050919050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b610895816108488 2525050565b6108a08161085e565b82525050565b6108af81610868565b81146108ba57600080fd5b50565b60006108c882610877565b9050919050565b60006108da82610868565b9050919050565b6000602082840312156108f7576108f6610868565b5b600061090584828501610652565b91505092915050565b6000604082840312156109245761092361 0868565b5b600061093284828501610652565b915050602061094384828501610667565b9150509250929050565b60006060828403121561096357610962610868565b5b600061097184828501610652565b925050602061098284828501610652565b915050604061099384828501610667565b9150509250925092505 6565b6109a881610868565b82525050565b6109b78161085e565b82525050565b60006109c88261087c565b9050919050565b60006109da8261088c565b9050919050565b60006109ec8261085e565b9050919050565b60006109fe82610868565b9050919050565b610a0e816108b8565b82525050565b610a1d8161085e565b82525050565b610a2c81610868565b82525050565b610a3b816108c8565b82525050565b6000610a4c826108d8565b9050919050565b6000610a5e82610868565b9050919050565b6000610a7082610868565b9050919050565b600082825260208201905092915050565b7f496e73756666696369656e742062616c616e636500000000000000000000000 0600082015250565b7f416c6c6f77616e63652065786365656465640000000000000000000000000000600082015250565b6000610abc82610a8f565b9050919050565b6000610ace82610aa6565b9050919050565b610ade81610848565b82525050565b610aed8161085e565b82525050565b610afc81610868565b82525050565b610b0b816108b8565b82525050565b610b1a816108c8565b82525050565b610b29816108d8565b82525050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fdfea2646970667358221220';

const CONTRACT_ABI = [
  {
    "inputs": [],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "name": "owner", "type": "address" },
      { "indexed": true, "name": "spender", "type": "address" },
      { "indexed": false, "name": "value", "type": "uint256" }
    ],
    "name": "Approval",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "name": "to", "type": "address" },
      { "indexed": false, "name": "amount", "type": "uint256" }
    ],
    "name": "Mint",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "name": "from", "type": "address" },
      { "indexed": true, "name": "to", "type": "address" },
      { "indexed": false, "name": "value", "type": "uint256" }
    ],
    "name": "Transfer",
    "type": "event"
  },
  {
    "inputs": [],
    "name": "name",
    "outputs": [{ "name": "", "type": "string" }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "symbol",
    "outputs": [{ "name": "", "type": "string" }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "decimals",
    "outputs": [{ "name": "", "type": "uint8" }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "totalSupply",
    "outputs": [{ "name": "", "type": "uint256" }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{ "name": "", "type": "address" }],
    "name": "balanceOf",
    "outputs": [{ "name": "", "type": "uint256" }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      { "name": "to", "type": "address" },
      { "name": "value", "type": "uint256" }
    ],
    "name": "transfer",
    "outputs": [{ "name": "", "type": "bool" }],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      { "name": "spender", "type": "address" },
      { "name": "value", "type": "uint256" }
    ],
    "name": "approve",
    "outputs": [{ "name": "", "type": "bool" }],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      { "name": "from", "type": "address" },
      { "name": "to", "type": "address" },
      { "name": "value", "type": "uint256" }
    ],
    "name": "transferFrom",
    "outputs": [{ "name": "", "type": "bool" }],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "faucet",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      { "name": "to", "type": "address" },
      { "name": "amount", "type": "uint256" }
    ],
    "name": "mint",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  }
];

async function main() {
  console.log('='.repeat(70));
  console.log('Deploying Mock USDT Contract to Sepolia Testnet...');
  console.log('='.repeat(70));
  console.log('');

  // Initialize Web3
  const web3 = new Web3(SEPOLIA_RPC_URL);

  // Create account from private key
  const account = web3.eth.accounts.privateKeyToAccount(PRIVATE_KEY);
  web3.eth.accounts.wallet.add(account);

  console.log('Deployer Address:', account.address);

  // Check balance
  const balance = await web3.eth.getBalance(account.address);
  const balanceEth = web3.utils.fromWei(balance, 'ether');
  console.log('ETH Balance:', balanceEth, 'ETH');

  if (parseFloat(balanceEth) < 0.01) {
    console.error('');
    console.error('ERROR: Insufficient ETH balance!');
    console.error('Please get Sepolia ETH from: https://sepoliafaucet.com/');
    console.error('You need at least 0.01 ETH for deployment');
    process.exit(1);
  }

  console.log('');
  console.log('Deploying contract...');

  // Create contract instance
  const contract = new web3.eth.Contract(CONTRACT_ABI);

  // Deploy contract
  const deploy = contract.deploy({
    data: CONTRACT_BYTECODE,
    arguments: []
  });

  try {
    const gas = await deploy.estimateGas({ from: account.address });
    console.log('Estimated Gas:', gas);

    const deployedContract = await deploy.send({
      from: account.address,
      gas: gas.toString(),
      gasPrice: (await web3.eth.getGasPrice()).toString()
    });

    console.log('');
    console.log('='.repeat(70));
    console.log('Contract Deployed Successfully!');
    console.log('='.repeat(70));
    console.log('');
    console.log('Contract Address:', deployedContract.options.address);
    console.log('');
    console.log('Add to .env.testnet:');
    console.log('USDT_CONTRACT_ADDRESS=' + deployedContract.options.address);
    console.log('');
    console.log('View on Etherscan:');
    console.log('https://sepolia.etherscan.io/address/' + deployedContract.options.address);
    console.log('');
    console.log('='.repeat(70));
    console.log('');
    console.log('NEXT STEPS:');
    console.log('1. Verify the contract source code on Etherscan (optional)');
    console.log('2. Call faucet() function to get 1000 USDT for testing');
    console.log('3. Update .env.testnet with the contract address');
    console.log('='.repeat(70));

  } catch (error) {
    console.error('');
    console.error('Deployment failed:', error.message);
    process.exit(1);
  }
}

main();
